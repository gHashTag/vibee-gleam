# Ona Agent Rules for VIBEE Project

## Deployment Rules

### When to Deploy

**ALWAYS deploy automatically when:**
1. User explicitly asks to deploy ("Ð´ÐµÐ¿Ð»Ð¾Ð¹", "deploy", "Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾Ð¹")
2. User says changes don't work on production
3. User provides deployment credentials (tokens, keys)
4. Code changes are committed and pushed to main branch
5. User confirms "Ð´Ð°Ð²Ð°Ð¹" or "go ahead" after deployment preparation

**NEVER ask for permission to deploy when:**
- User has already provided FLY_API_TOKEN
- User says "Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚" about production URL
- User explicitly requested deployment

### Deployment Process

1. **Check for credentials:**
   ```bash
   # Check if FLY_API_TOKEN is available
   env | grep FLY_API_TOKEN
   ```

2. **If token available, deploy immediately:**
   ```bash
   export FLY_API_TOKEN="token_value"
   cd /workspaces/vibee-gleam
   /home/vscode/.fly/bin/flyctl deploy --config fly.toml --remote-only
   ```

3. **If token not available, request it:**
   - Ask user to run: `flyctl auth token`
   - Once provided, deploy immediately without asking

4. **After deployment, verify:**
   ```bash
   curl https://vibee-mcp.fly.dev/health
   curl -I https://vibee-mcp.fly.dev/dashboard/agent
   ```

### Deployment Checklist

- [ ] Code committed and pushed to main
- [ ] FLY_API_TOKEN available or requested
- [ ] Run deployment command
- [ ] Wait for completion (3-5 minutes)
- [ ] Verify endpoints work
- [ ] Report success to user with URLs

## Git Operations

### Commit Rules

**ALWAYS include in commits:**
- Clear, descriptive commit message
- Co-authored-by: Ona <no-reply@ona.com>

**NEVER commit without:**
- Running `git status` first
- Checking what files changed with `git diff`
- Understanding commit message style with `git log --oneline -5`

### Push Rules

**Handle conflicts automatically:**
```bash
# If push rejected, pull and retry
git pull --rebase || git stash && git pull --rebase && git stash pop
git push origin main
```

**NEVER leave uncommitted changes** when switching tasks.

## File Operations

### Dashboard Files Location

**IMPORTANT:** Dashboard files must be in TWO locations:
1. `/workspaces/vibee-gleam/dashboard/` - source files
2. `/workspaces/vibee-gleam/gleam/dashboard/` - for runtime (app runs from gleam/)

**When creating/updating dashboard files:**
```bash
# Create in source
vim /workspaces/vibee-gleam/dashboard/agent.html

# Copy to runtime location
cp -r /workspaces/vibee-gleam/dashboard /workspaces/vibee-gleam/gleam/

# Commit both
git add dashboard/ gleam/dashboard/
```

### Dockerfile Rules

**Dashboard must be copied to /build/dashboard/:**
```dockerfile
COPY dashboard/ /build/dashboard/
```

**NEVER assume files are in different location** - always verify with `ls -la`.

## Testing Rules

### Local Testing

**ALWAYS test locally before deployment:**
```bash
cd /workspaces/vibee-gleam/gleam
gleam build
gleam run &
sleep 5
curl http://localhost:8080/dashboard/agent
```

**If local test fails, FIX before deploying.**

### Production Testing

**After deployment, ALWAYS verify:**
```bash
curl https://vibee-mcp.fly.dev/health
curl -I https://vibee-mcp.fly.dev/dashboard/agent
curl -I https://vibee-mcp.fly.dev/logs
```

## Communication Rules

### When Deployment Succeeds

**Report immediately with:**
- âœ… Success emoji
- Working URLs
- Brief feature list
- "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!" or "Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"

**Example:**
```
ðŸŽ‰ Dashboard Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!

https://vibee-mcp.fly.dev/dashboard/agent

Features:
- Control Panel (Ð»ÐµÐ²Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ)
- Analytics Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°Ð¼Ð¸ (Ñ†ÐµÐ½Ñ‚Ñ€)
- Telegram Logs (ÑÐ¿Ñ€Ð°Ð²Ð°)

Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ðŸš€
```

### When Deployment Fails

**Report immediately with:**
- âŒ Error emoji
- Error message
- What you're doing to fix
- ETA for fix

**Example:**
```
âŒ Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÐ¿Ð°Ð»: No access token

Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽ Ñ‚Ð¾ÐºÐµÐ½...
Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: flyctl auth token
```

### When User Says "Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"

**NEVER just create documentation** - ACT:
1. Check production URL immediately
2. Compare with local version
3. If different - deploy immediately
4. If same - debug the issue

## Fly.io Specific Rules

### Fly CLI Setup

**ALWAYS ensure Fly CLI is available:**
```bash
# Check if installed
/home/vscode/.fly/bin/flyctl version || {
  # Install if missing
  curl -L https://fly.io/install.sh | sh
}

# Add to PATH for current session
export PATH="/home/vscode/.fly/bin:$PATH"
```

### Token Management

**Token priority:**
1. Environment variable: `$FLY_API_TOKEN`
2. User-provided token (from `flyctl auth token`)
3. Request from user if neither available

**NEVER proceed without token** - deployment will fail.

### Deployment Command

**Standard deployment:**
```bash
export FLY_API_TOKEN="token_value"
cd /workspaces/vibee-gleam
/home/vscode/.fly/bin/flyctl deploy --config fly.toml --remote-only
```

**ALWAYS use `--remote-only`** - builds on Fly.io servers, not locally.

## Error Handling

### Common Errors and Fixes

**"No access token available"**
- Request token from user
- Set FLY_API_TOKEN environment variable
- Retry deployment

**"Could not find App"**
- App doesn't exist on Fly.io
- Check app name in fly.toml
- Verify user has access to app

**"Build failed"**
- Check Dockerfile syntax
- Verify all files are copied
- Test build locally first

**"Health check failed"**
- App not responding on /health
- Check logs: `flyctl logs`
- Verify PORT environment variable

### Recovery Process

1. Identify error from logs
2. Fix the issue
3. Commit and push fix
4. Deploy again immediately
5. Verify fix worked

## Documentation Rules

### When to Create Docs

**Create documentation for:**
- New features
- Complex workflows
- Troubleshooting guides
- API changes

**NEVER create docs instead of fixing** - fix first, document after.

### Documentation Format

**Use clear structure:**
- Problem statement
- Solution steps
- Code examples
- Verification commands

**Example:**
```markdown
## Problem
Dashboard returns 404

## Solution
1. Check files exist
2. Verify routes in router.gleam
3. Deploy with correct Dockerfile

## Verification
curl https://vibee-mcp.fly.dev/dashboard/agent
```

## Project-Specific Rules

### VIBEE Architecture

**Key components:**
- Gleam backend (HTTP server)
- Dashboard (static HTML/JS/CSS)
- Telegram integration (via Go bridge)
- WebSocket for real-time logs

**File structure:**
```
/workspaces/vibee-gleam/
â”œâ”€â”€ gleam/              # Gleam source (app runs from here)
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ dashboard/      # Runtime dashboard files
â”œâ”€â”€ dashboard/          # Source dashboard files
â”œâ”€â”€ Dockerfile          # Build configuration
â””â”€â”€ fly.toml           # Fly.io configuration
```

### Router Configuration

**Dashboard routes in `gleam/src/vibee/api/router.gleam`:**
```gleam
http.Get, ["dashboard", "agent"] -> serve_agent_dashboard()
http.Get, ["logs"] -> serve_logs_file()
```

**File serving functions:**
```gleam
fn serve_agent_dashboard() -> Response(ResponseData) {
  case simplifile.read("dashboard/agent.html") {
    Ok(content) -> html_response(200, content)
    Error(_) -> html_response(404, "Not found")
  }
}
```

## Summary

**Core principle:** When user says "Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚" or provides credentials - DEPLOY IMMEDIATELY, don't just document.

**Deployment flow:**
1. User reports issue or provides token
2. Verify issue on production
3. Deploy fix immediately
4. Verify fix worked
5. Report success

**NEVER:**
- Ask permission when credentials provided
- Create docs instead of deploying
- Leave production broken
- Ignore "Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚" reports

**ALWAYS:**
- Deploy when user provides token
- Verify after deployment
- Report results clearly
- Fix issues immediately
